'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = watcher;

var _chokidar = require('chokidar');

var _chokidar2 = _interopRequireDefault(_chokidar);

var _eslint = require('eslint');

var _eslint2 = _interopRequireDefault(_eslint);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _settings = require('./settings');

var _settings2 = _interopRequireDefault(_settings);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _clearTerminal = require('./formatters/helpers/clear-terminal.js');

var _clearTerminal2 = _interopRequireDefault(_clearTerminal);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var logger = (0, _logger2.default)('watcher');

logger.debug('Loaded');

var events = { change: 'change' };
var chokidarOptions = {
  ignored: /\.git|node_modules|bower_components/
};
var cliOptionProperties = ['config', 'eslintrc', 'ext', 'parser', 'cache', 'cacheLocation', 'ignore', 'ignorePath', 'ignorePattern', 'fix', 'parserOptions', 'global'];
var cliOptionMap = {
  config: 'configFile',
  eslintrc: 'useEslintrc',
  ext: 'extensions',
  cacheFile: 'cacheLocation'
};

function filterWarnings(results) {
  return _lodash2.default.reduce(results, function (curr, result) {
    if (result.warningCount) {
      var newResult = _lodash2.default.omit(result, 'messages');
      newResult.messages = _lodash2.default.filter(result.messages, function (m) {
        return m.severity > 1;
      });
      curr.push(newResult);
      return curr;
    }
    curr.push(result);
    return curr;
  }, []);
}

function requireFormatter(formatterPath) {
  try {
    return require(formatterPath);
  } catch (ex) {
    ex.message = `There was a problem loading formatter: ${formatterPath}\nError: ${ex.message}`;
    throw ex;
  }
}

function getFormatter(cli, formatter) {
  var pathToFormatterSpecified = formatter.includes('\\');
  var isSimpleFormatter = formatter.includes('simple');
  var formatterPath = formatter.replace(/\\/g, '/');

  if (isSimpleFormatter) {
    logger.debug(`Formatter local: ${formatter}`);

    return requireFormatter(`./formatters/${formatterPath}`);
  } else if (pathToFormatterSpecified) {
    var cwd = process.cwd();

    logger.debug('Formatter user:', formatterPath);
    var location = _path2.default.resolve(cwd, formatterPath);

    return requireFormatter(location);
  }

  logger.debug(`Formatter eslint: ${formatter}`);

  return cli.getFormatter(formatter);
}

///https://github.com/eslint/eslint/blob/233440e524aa41545b66b2c3c7ca26fe790e32e0/tests/lib/cli-engine.js#L105-L107

function watcher(options) {
  var cliOptions = (0, _lodash2.default)(options).pick(cliOptionProperties).reduce(function (result, value, key) {
    key = cliOptionMap[key] || key;
    result[key] = value;
    return result;
  }, {});
  logger.debug('cli', cliOptions);
  logger.debug('options', options);
  var cli = new _eslint2.default.CLIEngine(cliOptions);
  var watchDir = options._.length ? options._ : [_path2.default.resolve('./')];

  var formatter = getFormatter(cli, options.format);

  function lintFile(path) {
    logger.debug('lintFile: %s', path);
    if (options.clear) {
      (0, _clearTerminal2.default)();
    }
    var report = cli.executeOnFiles(path);
    if (options.fix) {
      _eslint2.default.CLIEngine.outputFixes(report);
    }
    var results = _settings2.default.cliOptions.quiet ? filterWarnings(report.results) : report.results;

    logger.log(formatter(results));
  }

  function isWatchableExtension(filePath, extensions) {
    logger.debug(filePath, extensions);
    if (extensions) {
      return _lodash2.default.includes(extensions, _path2.default.extname(filePath));
    }

    // Use the ESLint default extension, if none is provided
    return _lodash2.default.includes(cli.options.extensions, _path2.default.extname(filePath));
  }

  _chokidar2.default.watch(watchDir, chokidarOptions).on(events.change, function changeEvent(path) {
    logger.debug('Changed:', path);
    if (!cli.isPathIgnored(path) && isWatchableExtension(path, options.ext)) {
      var watchPath = options.changed ? [path] : watchDir;

      lintFile(watchPath);
    }
  }).on('error', logger.error);

  logger.debug('Watching: %o', watchDir);
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLmpzIl0sIm5hbWVzIjpbIndhdGNoZXIiLCJsb2dnZXIiLCJkZWJ1ZyIsImV2ZW50cyIsImNoYW5nZSIsImNob2tpZGFyT3B0aW9ucyIsImlnbm9yZWQiLCJjbGlPcHRpb25Qcm9wZXJ0aWVzIiwiY2xpT3B0aW9uTWFwIiwiY29uZmlnIiwiZXNsaW50cmMiLCJleHQiLCJjYWNoZUZpbGUiLCJmaWx0ZXJXYXJuaW5ncyIsInJlc3VsdHMiLCJyZWR1Y2UiLCJjdXJyIiwicmVzdWx0Iiwid2FybmluZ0NvdW50IiwibmV3UmVzdWx0Iiwib21pdCIsIm1lc3NhZ2VzIiwiZmlsdGVyIiwibSIsInNldmVyaXR5IiwicHVzaCIsInJlcXVpcmVGb3JtYXR0ZXIiLCJmb3JtYXR0ZXJQYXRoIiwicmVxdWlyZSIsImV4IiwibWVzc2FnZSIsImdldEZvcm1hdHRlciIsImNsaSIsImZvcm1hdHRlciIsInBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCIsImluY2x1ZGVzIiwiaXNTaW1wbGVGb3JtYXR0ZXIiLCJyZXBsYWNlIiwiY3dkIiwicHJvY2VzcyIsImxvY2F0aW9uIiwicmVzb2x2ZSIsIm9wdGlvbnMiLCJjbGlPcHRpb25zIiwicGljayIsInZhbHVlIiwia2V5IiwiQ0xJRW5naW5lIiwid2F0Y2hEaXIiLCJfIiwibGVuZ3RoIiwiZm9ybWF0IiwibGludEZpbGUiLCJwYXRoIiwiY2xlYXIiLCJyZXBvcnQiLCJleGVjdXRlT25GaWxlcyIsImZpeCIsIm91dHB1dEZpeGVzIiwicXVpZXQiLCJsb2ciLCJpc1dhdGNoYWJsZUV4dGVuc2lvbiIsImZpbGVQYXRoIiwiZXh0ZW5zaW9ucyIsImV4dG5hbWUiLCJ3YXRjaCIsIm9uIiwiY2hhbmdlRXZlbnQiLCJpc1BhdGhJZ25vcmVkIiwid2F0Y2hQYXRoIiwiY2hhbmdlZCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7OztrQkE4RXdCQSxPOztBQTlFeEI7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFF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SixFQUFnQjtBQUNkLGFBQU8saUJBQUU1QixRQUFGLENBQVc0QixVQUFYLEVBQXVCLGVBQUtDLE9BQUwsQ0FBYUYsUUFBYixDQUF2QixDQUFQO0FBQ0Q7O0FBRUQ7QUFDQSxXQUFPLGlCQUFFM0IsUUFBRixDQUFXSCxJQUFJVSxPQUFKLENBQVlxQixVQUF2QixFQUFtQyxlQUFLQyxPQUFMLENBQWFGLFFBQWIsQ0FBbkMsQ0FBUDtBQUNEOztBQUVELHFCQUFTRyxLQUFULENBQWVqQixRQUFmLEVBQXlCM0MsZUFBekIsRUFDRzZELEVBREgsQ0FDTS9ELE9BQU9DLE1BRGIsRUFDcUIsU0FBUytELFdBQVQsQ0FBcUJkLElBQXJCLEVBQTJCO0FBQzVDcEQsV0FBT0MsS0FBUCxDQUFhLFVBQWIsRUFBeUJtRCxJQUF6QjtBQUNBLFFBQUksQ0FBQ3JCLElBQUlvQyxhQUFKLENBQWtCZixJQUFsQixDQUFELElBQTRCUSxxQkFBcUJSLElBQXJCLEVBQTJCWCxRQUFRL0IsR0FBbkMsQ0FBaEMsRUFBeUU7QUFDdkUsVUFBTTBELFlBQVkzQixRQUFRNEIsT0FBUixHQUNkLENBQUNqQixJQUFELENBRGMsR0FFZEwsUUFGSjs7QUFJQUksZUFBU2lCLFNBQVQ7QUFDRDtBQUNGLEdBVkgsRUFVS0gsRUFWTCxDQVVRLE9BVlIsRUFVaUJqRSxPQUFPc0UsS0FWeEI7O0FBWUF0RSxTQUFPQyxLQUFQLENBQWEsY0FBYixFQUE2QjhDLFFBQTdCO0FBQ0QiLCJmaWxlIjoid2F0Y2hlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaG9raWRhciBmcm9tICdjaG9raWRhcic7XG5pbXBvcnQgZXNsaW50IGZyb20gJ2VzbGludCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCBzZXR0aW5ncyBmcm9tICcuL3NldHRpbmdzJztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IGNsZWFyVGVybWluYWwgZnJvbSAnLi9mb3JtYXR0ZXJzL2hlbHBlcnMvY2xlYXItdGVybWluYWwuanMnO1xuXG5jb25zdCBsb2dnZXIgPSBMb2dnZXIoJ3dhdGNoZXInKTtcblxubG9nZ2VyLmRlYnVnKCdMb2FkZWQnKTtcblxuY29uc3QgZXZlbnRzID0geyBjaGFuZ2U6ICdjaGFuZ2UnIH07XG5jb25zdCBjaG9raWRhck9wdGlvbnMgPSB7XG4gIGlnbm9yZWQ6IC9cXC5naXR8bm9kZV9tb2R1bGVzfGJvd2VyX2NvbXBvbmVudHMvXG59O1xuY29uc3QgY2xpT3B0aW9uUHJvcGVydGllcyA9IFtcbiAgJ2NvbmZpZycsICdlc2xpbnRyYycsICdleHQnLFxuICAncGFyc2VyJywgJ2NhY2hlJywgJ2NhY2hlTG9jYXRpb24nLFxuICAnaWdub3JlJywgJ2lnbm9yZVBhdGgnLCAnaWdub3JlUGF0dGVybicsXG4gICdmaXgnLCAncGFyc2VyT3B0aW9ucycsICdnbG9iYWwnXG5dO1xuY29uc3QgY2xpT3B0aW9uTWFwID0ge1xuICBjb25maWc6ICdjb25maWdGaWxlJyxcbiAgZXNsaW50cmM6ICd1c2VFc2xpbnRyYycsXG4gIGV4dDogJ2V4dGVuc2lvbnMnLFxuICBjYWNoZUZpbGU6ICdjYWNoZUxvY2F0aW9uJ1xufTtcblxuZnVuY3Rpb24gZmlsdGVyV2FybmluZ3MocmVzdWx0cykge1xuICByZXR1cm4gXy5yZWR1Y2UocmVzdWx0cywgKGN1cnIsIHJlc3VsdCkgPT57XG4gICAgaWYgKHJlc3VsdC53YXJuaW5nQ291bnQpIHtcbiAgICAgIGxldCBuZXdSZXN1bHQgPSBfLm9taXQocmVzdWx0LCAnbWVzc2FnZXMnKTtcbiAgICAgIG5ld1Jlc3VsdC5tZXNzYWdlcyA9IF8uZmlsdGVyKHJlc3VsdC5tZXNzYWdlcywgKG0pID0+IG0uc2V2ZXJpdHkgPiAxKTtcbiAgICAgIGN1cnIucHVzaChuZXdSZXN1bHQpO1xuICAgICAgcmV0dXJuIGN1cnI7XG4gICAgfVxuICAgIGN1cnIucHVzaChyZXN1bHQpO1xuICAgIHJldHVybiBjdXJyO1xuICB9LCBbXSk7XG59XG5cbmZ1bmN0aW9uIHJlcXVpcmVGb3JtYXR0ZXIoZm9ybWF0dGVyUGF0aCkge1xuICB0cnkge1xuICAgIHJldHVybiByZXF1aXJlKGZvcm1hdHRlclBhdGgpO1xuICB9IGNhdGNoIChleCkge1xuICAgIGV4Lm1lc3NhZ2UgPSBgVGhlcmUgd2FzIGEgcHJvYmxlbSBsb2FkaW5nIGZvcm1hdHRlcjogJHtmb3JtYXR0ZXJQYXRofVxcbkVycm9yOiAke2V4Lm1lc3NhZ2V9YDtcbiAgICB0aHJvdyBleDtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRGb3JtYXR0ZXIoY2xpLCBmb3JtYXR0ZXIpIHtcbiAgY29uc3QgcGF0aFRvRm9ybWF0dGVyU3BlY2lmaWVkID0gZm9ybWF0dGVyLmluY2x1ZGVzKCdcXFxcJyk7XG4gIGNvbnN0IGlzU2ltcGxlRm9ybWF0dGVyID0gZm9ybWF0dGVyLmluY2x1ZGVzKCdzaW1wbGUnKTtcbiAgY29uc3QgZm9ybWF0dGVyUGF0aCA9IGZvcm1hdHRlci5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cbiAgaWYgKGlzU2ltcGxlRm9ybWF0dGVyKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBGb3JtYXR0ZXIgbG9jYWw6ICR7IGZvcm1hdHRlciB9YCk7XG5cbiAgICByZXR1cm4gcmVxdWlyZUZvcm1hdHRlcihgLi9mb3JtYXR0ZXJzLyR7IGZvcm1hdHRlclBhdGggfWApO1xuICB9IGVsc2UgaWYgKHBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCkge1xuICAgIGNvbnN0IGN3ZCA9IHByb2Nlc3MuY3dkKCk7XG5cbiAgICBsb2dnZXIuZGVidWcoJ0Zvcm1hdHRlciB1c2VyOicsIGZvcm1hdHRlclBhdGgpO1xuICAgIGNvbnN0IGxvY2F0aW9uID0gcGF0aC5yZXNvbHZlKGN3ZCwgZm9ybWF0dGVyUGF0aCk7XG5cbiAgICByZXR1cm4gcmVxdWlyZUZvcm1hdHRlcihsb2NhdGlvbik7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoYEZvcm1hdHRlciBlc2xpbnQ6ICR7IGZvcm1hdHRlciB9YCk7XG5cbiAgcmV0dXJuIGNsaS5nZXRGb3JtYXR0ZXIoZm9ybWF0dGVyKTtcblxufVxuXG4vLy9odHRwczovL2dpdGh1Yi5jb20vZXNsaW50L2VzbGludC9ibG9iLzIzMzQ0MGU1MjRhYTQxNTQ1YjY2YjJjM2M3Y2EyNmZlNzkwZTMyZTAvdGVzdHMvbGliL2NsaS1lbmdpbmUuanMjTDEwNS1MMTA3XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHdhdGNoZXIob3B0aW9ucykge1xuICBjb25zdCBjbGlPcHRpb25zID0gXyhvcHRpb25zKVxuICAgIC5waWNrKGNsaU9wdGlvblByb3BlcnRpZXMpXG4gICAgLnJlZHVjZShmdW5jdGlvbiAocmVzdWx0LCB2YWx1ZSwga2V5KSB7XG4gICAgICBrZXkgPSBjbGlPcHRpb25NYXBba2V5XSB8fCBrZXk7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSk7XG4gIGxvZ2dlci5kZWJ1ZygnY2xpJywgY2xpT3B0aW9ucyk7XG4gIGxvZ2dlci5kZWJ1Zygnb3B0aW9ucycsIG9wdGlvbnMpO1xuICBjb25zdCBjbGkgPSBuZXcgZXNsaW50LkNMSUVuZ2luZShjbGlPcHRpb25zKTtcbiAgY29uc3Qgd2F0Y2hEaXIgPSBvcHRpb25zLl8ubGVuZ3RoXG4gICAgPyBvcHRpb25zLl9cbiAgICA6IFtwYXRoLnJlc29sdmUoJy4vJyldO1xuXG4gIGNvbnN0IGZvcm1hdHRlciA9IGdldEZvcm1hdHRlcihjbGksIG9wdGlvbnMuZm9ybWF0KTtcblxuICBmdW5jdGlvbiBsaW50RmlsZShwYXRoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdsaW50RmlsZTogJXMnLCBwYXRoKTtcbiAgICBpZiAob3B0aW9ucy5jbGVhcikge1xuICAgICAgY2xlYXJUZXJtaW5hbCgpO1xuICAgIH1cbiAgICBjb25zdCByZXBvcnQgPSBjbGkuZXhlY3V0ZU9uRmlsZXMocGF0aCk7XG4gICAgaWYgKG9wdGlvbnMuZml4KSB7XG4gICAgICBlc2xpbnQuQ0xJRW5naW5lLm91dHB1dEZpeGVzKHJlcG9ydCk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdHMgPSBzZXR0aW5ncy5jbGlPcHRpb25zLnF1aWV0XG4gICAgICA/IGZpbHRlcldhcm5pbmdzKHJlcG9ydC5yZXN1bHRzKVxuICAgICAgOiByZXBvcnQucmVzdWx0cztcblxuICAgIGxvZ2dlci5sb2coZm9ybWF0dGVyKHJlc3VsdHMpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzV2F0Y2hhYmxlRXh0ZW5zaW9uKGZpbGVQYXRoLCBleHRlbnNpb25zKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGZpbGVQYXRoLCBleHRlbnNpb25zKTtcbiAgICBpZiAoZXh0ZW5zaW9ucykge1xuICAgICAgcmV0dXJuIF8uaW5jbHVkZXMoZXh0ZW5zaW9ucywgcGF0aC5leHRuYW1lKGZpbGVQYXRoKSk7XG4gICAgfVxuXG4gICAgLy8gVXNlIHRoZSBFU0xpbnQgZGVmYXVsdCBleHRlbnNpb24sIGlmIG5vbmUgaXMgcHJvdmlkZWRcbiAgICByZXR1cm4gXy5pbmNsdWRlcyhjbGkub3B0aW9ucy5leHRlbnNpb25zLCBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpKTtcbiAgfVxuXG4gIGNob2tpZGFyLndhdGNoKHdhdGNoRGlyLCBjaG9raWRhck9wdGlvbnMpXG4gICAgLm9uKGV2ZW50cy5jaGFuZ2UsIGZ1bmN0aW9uIGNoYW5nZUV2ZW50KHBhdGgpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnQ2hhbmdlZDonLCBwYXRoKTtcbiAgICAgIGlmICghY2xpLmlzUGF0aElnbm9yZWQocGF0aCkgJiYgaXNXYXRjaGFibGVFeHRlbnNpb24ocGF0aCwgb3B0aW9ucy5leHQpKSB7XG4gICAgICAgIGNvbnN0IHdhdGNoUGF0aCA9IG9wdGlvbnMuY2hhbmdlZFxuICAgICAgICAgID8gW3BhdGhdXG4gICAgICAgICAgOiB3YXRjaERpcjtcblxuICAgICAgICBsaW50RmlsZSh3YXRjaFBhdGgpO1xuICAgICAgfVxuICAgIH0pLm9uKCdlcnJvcicsIGxvZ2dlci5lcnJvcik7XG5cbiAgbG9nZ2VyLmRlYnVnKCdXYXRjaGluZzogJW8nLCB3YXRjaERpcik7XG59O1xuIl19